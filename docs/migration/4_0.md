# Technical Changes in Spartacus 4.0

## Before migrating to Spartacus 4.0

Before you migrate to version 4.0 of libraries we recommend to switch to new app structure and new feature libraries. Read the next chapter if you need more insights why we introduce this change.

### Reasons for migration to new app structure

Before the 3.0 release we started to separate libraries based on it's responsibility. With 3.0 we already released few libraries in separate packages (eg. @spartacus/organization, @spartacus/storefinder). We kept moving more libraries in the minor 3.x releases as well. We tried to do that in a no breaking-changes manner. However with each major release we want to pay off tech debt we accumulated during minor releases. Extracted libraries are huge contributor to tech debt, as we keep the same functionality in 2 places. With 4.0 release we will remove the functionality from core libraries (@spartacus/core, @spartacus/storefront, @spartacus/assets and @spartacus/styles) that was already extracted to separate libraries in minor releases.

Along the way we discovered that we had to change few of the bigger modules to accommodate these changes (eg. `B2cStoreFrontModule`, `StorefrontModule` or `CmsLibModule`).

So that's why we recommend to switch to new app structure that is not using these modules and to switch to new feature libraries if they exists for the features you are using. Below you can find generic guide on how to do it. After that migration to 4.0 should be easier.

### Migrating to new, reference app structure

Before you start to migrate to new app structure read the reasoning behind the change [here](https://sap.github.io/spartacus-docs/reference-app-structure/).

So let's migrate to the new structure step by step.

1. Create `SpartacusModule` under `app/spartacus/spartacus.module.ts` path and add it to `imports` in `AppModule`.
2. Add `BaseStorefrontModule` to imports and exports of `SpartacusModule`. This modules is exported from `@spartacus/storefront` library.
3. Create `SpartacusFeaturesModule` under `app/spartacus/spartacus-features.module.ts` path and add it to `imports` in `SpartacusModule`.
4. Create `SpartacusConfigurationModule` under `app/spartacus/spartacus-configuration.module.ts` path and add it to `imports` in `SpartacusModule`.
5. Move spartacus configuration to `SpartacusConfigurationModule`. That would be the configurations you pass with `provideConfig`, `provideConfigFactory` or with `withConfig` methods from some of the modules (eg. `B2cStorefrontModule`, `ConfigModule`). We recommend to use `provideConfig` or `provideConfigFactory` in module providers to configure spartacus.
6. Configure `AppRoutingModule`. If you don't have this module, first create it under `app/app-routing.module.ts`. Don't forget to import this module in `AppModule`. In `AppRoutingModule` imports configure `RouterModule` with these 3 options:

    ```ts
    RouterModule.forRoot([], {
      anchorScrolling: 'enabled',
      relativeLinkResolution: 'corrected',
      initialNavigation: 'enabled',
    }),
    ```

    Previously this module was configured in `StorefrontModule`, which is now deprecated and removed in version 4.0.

7. Configure ngrx modules in `AppModule`. They were part of the `StorefrontModule`, but similarly like `RouterModule` we require this configuration to be present in application. You need to add to `imports` 2 modules: `StoreModule.forRoot({})` and `EffectsModule.forRoot([])`. Import these modules from `@ngrx/store` and from `@ngrx/effects`.

    ```ts
    @NgModule({
      imports: [
        AppRoutingModule,
        StoreModule.forRoot({}),
        EffectsModule.forRoot([]),
        SpartacusModule
      ],
      ...
    ```

8. Now let's focus on replacing deprecated Spartacus grouping modules

    1. Migrating `B2cStorefrontModule`.
        - config from `B2cStorefrontModule.withConfig` should be already moved to `SpartacusConfigurationModule` and provided with `provideConfig`
        - first add `HttpClientModule` to imports in `AppModule` if it's not present there
        - now add in `SpartacusFeaturesModule` module imports two modules from `@spartacus/storefront`: `StorefrontModule` and `CmsLibModule`. These modules are also deprecated, but we want to migrate the modules step by step. Migration of those modules will be covered in next steps.
        - this module provided few default configs, so add them to your `SpartacusConfigurationModule` if you rely on them

            ```ts
            provideConfig({
              pwa: {
                enabled: true,
                addToHomeScreen: true,
              },
            }),
            provideConfig(layoutConfig),
            provideConfig(mediaConfig),
            ...defaultCmsContentProviders,
            ```

        - remove usage of `B2cStorefrontModule` from your app

    2. Migrating `B2bStorefrontModule`.
        - config from `B2bStorefrontModule.withConfig` should be already moved to `SpartacusConfigurationModule` and provided with `provideConfig`
        - add `HttpClientModule` to imports in `AppModule` if it's not present there
        - add in `SpartacusFeaturesModule` imports few modules: `StorefrontModule`, `CmsLibModule` from `@spartacus/storefront` and `CostCenterModule.forRoot()` from `@spartacus/core`
        - this module provided few default configs, so add them to your `SpartacusConfigurationModule` if you rely on them

            ```ts
            provideDefaultConfig(layoutConfig),
            provideDefaultConfig(mediaConfig),
            provideDefaultConfig(defaultB2bOccConfig),
            provideDefaultConfig(defaultB2bCheckoutConfig),
            ...defaultCmsContentProviders,
            ```

        - remove usage of `B2bStorefrontModule` from your app

    3. Migrating `StorefrontModule`
        - you should have configured `RouterModule` in `AppRoutingModule`
        - in `AppModule` you should already have `StoreModule.forRoot({})` and `EffectsModule.forRoot([])` present in `imports`
        - add `AsmModule` from `@spartacus/storefront` to imports in `SpartacusFeaturesModule`
        - add `StorefrontFoundationModule` to `SpartacusFeaturesModule` imports. We will migrate it in next steps
        - Add `MainModule` to `SpartacusFeaturesModule` imports
        - Add `SmartEditModule.forRoot()`, `PersonalizationModule.forRoot()` and `OccModule.forRoot()` from `@spartacus/core` to imports in `SpartacusFeaturesModule`
        - Add `ProductDetailsPageModule` and `ProductListingPageModule` from `@spartacus/storefront` to imports in `SpartacusFeaturesModule`
        - Add `ExternalRoutesModule.forRoot()` from `@spartacus/core` to imports in `SpartacusFeaturesModule`
        - remove usage of `StorefrontModule` from you app

    4. Migrating `CmsLibModule`
        - add imports listed below from `@spartacus/storefront` directly to imports in `SpartacusFeaturesModule`:

            ```ts
            AnonymousConsentManagementBannerModule,
            AsmModule,
            HamburgerMenuModule,
            CmsParagraphModule,
            LinkModule,
            BannerModule,
            CategoryNavigationModule,
            NavigationModule,
            FooterNavigationModule,
            BreadcrumbModule,
            SearchBoxModule,
            SiteContextSelectorModule,
            QualtricsModule,
            AddressBookModule,
            OrderHistoryModule,
            OrderCancellationModule,
            OrderReturnModule,
            ReturnRequestListModule,
            ReturnRequestDetailModule,
            ProductListModule,
            ProductFacetNavigationModule,
            ProductTabsModule,
            ProductCarouselModule,
            ProductReferencesModule,
            OrderDetailsModule,
            PaymentMethodsModule,
            ConsentManagementModule,
            CartComponentModule,
            TabParagraphContainerModule,
            OrderConfirmationModule,
            ProductImagesModule,
            ProductSummaryModule,
            ProductVariantsModule,
            ProductIntroModule,
            CheckoutComponentModule,
            BannerCarouselModule,
            MyCouponsModule,
            WishListModule,
            NotificationPreferenceModule,
            MyInterestsModule,
            StockNotificationModule,
            ReplenishmentOrderHistoryModule,
            ReplenishmentOrderConfirmationModule,
            ReplenishmentOrderDetailsModule,
            UserComponentModule,
            CloseAccountModule,
            UpdateEmailModule,
            UpdatePasswordModule,
            UpdateProfileModule,
            ForgotPasswordModule,
            ResetPasswordModule,
            ```

        - remove usage of `CmsLibModule` from your app

    5. Migrating `MainModule`
        - add `AnonymousConsentsDialogModule` from `@spartacus/storefront` into imports in `SpartacusFeaturesModule`
        - remove usage of `MainModule` from you app

    6. Migrating `StorefrontFoundationModule`
        - add `AuthModule.forRoot()`, `AnonymousConsentsModule.forRoot()`, `CartModule.forRoot()`, `CheckoutModule.forRoot()`, `UserModule.forRoot()` and `ProductModule.forRoot()` from `@spartacus/core` into imports in `SpartacusFeaturesModule`
        - add `CartPageEventModule`, `PageEventModule` and `ProductPageEventModule` from `@spartacus/storefront` into imports in `SpartacusFeaturesModule`
        - remove usage of `StorefrontFoundationModule` from your app

    7. Migrating `OccModule`
        - add `AsmOccModule`, `CartOccModule`, `CheckoutOccModule`, `ProductOccModule`, `UserOccModule`, `CostCenterOccModule` from `@spartacus/core` to imports in `SpartacusFeaturesModule`
        - remove usage of `OccModule` from your app

    8. Migrating `EventsModule`
        - add `CartPageEventModule`, `PageEventModule` and `ProductPageEventModule` from `@spartacus/storefront` to imports in `SpartacusFeaturesModule`
        - remove usage of `EventsModule` from your app

## Breaking Changes Introduced in 4.0

### Changes to Styles in 4.0

#### Changes in storefrontstyles components

`$page-template-blacklist` scss variable name has been renamed to `$page-template-blocklist` in `_page-template.scss`.

`$cart-components-whitelist` scss variable name has been renamed to `$cart-components-allowlist` in `cart/_index.scss`.

`$cds-components-whitelist` scss variable name has been renamed to `$cds-components-allowlist` in `cds/index.scss`.

`$checkout-components-whitelist` scss variable name has been renamed to `$checkout-components-allowlist` in `checkout/_index.scss`.

`$content-components-whitelist` scss variable name has been renamed to `$content-components-allowlist` in `content/_index.scss`.

`$layout-components-whitelist` scss variable name has been renamed to `$layout-components-allowlist` in `layout/_index.scss`.

`$misc-components-whitelist` scss variable name has been renamed to `$misc-components-allowlist` in `misc/_index.scss `.

`$myaccount-components-whitelist` scss variable name has been renamed to `$myaccount-components-allowlist` in `myaccount/_index.scss`.

`$product-components-whitelist` scss variable name has been renamed to `$product-components-allowlist` in `product/index.scss`.

`$product-list-whitelist` scss variable name has been renamed to `$product-list-allowlist` in `product/list/_index.scss`.

`$pwa-components-whitelist` scss variable name has been renamed to `$pwa-components-allowlist` in `pwa/add-to-home-screen-banner/_index.scss`.

`$user-components-whitelist` scss variable name has been renamed to `$user-components-allowlist` in `user/_index.scss`.

`$wish-list-components-whitelist` scss variable name has been renamed to `$wish-list-components-allowlist` in `wish-list/index.scss`.

#### Changes in Organization feature library

`$page-template-blacklist-organization` scss variable name has been renamed to `$page-template-blocklist-organization`.

`$page-template-whitelist-organization` scss variable name has been renamed to `$page-template-allowlist-organization`.

#### Changes in Storefinder feature library

`$page-template-blacklist-store-finder` scss variable name has been renamed to `$page-template-blocklist-store-finder`.

`$page-template-whitelist-store-finder` scss variable name has been renamed to `$page-template-allowlist-store-finder`.

### Removal of grouping modules

In 4.0 release we removed few modules that were grouping feature modules and provided some default configuration.

To migrate them check this section: `Before migrating to Spartacus 4.0`

- removed `B2cStorefrontModule` from `@spartacus/storefront`
- removed `B2bStorefrontModule` from `@spartacus/setup`
- removed `StorefrontModule` from `@spartacus/storefront`
- removed `CmsLibModule` from `@spartacus/storefront`
- removed `MainModule` from `@spartacus/storefront`
- removed `StorefrontFoundationModule` from `@spartacus/storefront`
- removed `OccModule` from `@spartacus/core`
- removed `EventsModule` from `@spartacus/storefront`

### ViewConfigModule removed

This module only provided empty default configuration that is not needed. This module was pretty much useless.

### EventService

- `EventService` will now register event's parent as an event. For more, see [this docs page](https://sap.github.io/spartacus-docs/event-service/#event-type-inheritance).

### ConfiguratorAttributeDropDownComponent

Method `onSelect` has been removed, it is no longer used. Use `onSelect` from super class which takes the value as argument

### ConfiguratorAttributeNumericInputFieldComponent

Method `createEventFromInput` has been removed, it is no longer used

### ConfiguratorAttributeRadioButtonComponent

Method `onDeselect` has been removed, it is no longer used

### ConfiguratorProductTitleComponent

Methods `getProductImageURL`, `getProductImageAlt` and `clickOnEnter` have been removed, there are no longer used

### LoginRegisterComponent

Lib: @spartacus/user
Class: LoginRegisterComponent

Change: constructor parameter `checkoutConfigService: CheckoutConfigService` is removed.
The display of the guest checkout button relies on the presence of the `forced` query param only.

### NgbTabsetModule

#### StoreFinderComponentsModule

- Deprecated import `NgbTabsetModule` from `@ng-bootstrap/ng-bootstrap` has been replaced with `NgbNavModule` to support version 8 of the library.

#### StoreFinderListComponent

- Mobile template has been updated to use nav instead of tabs. [See changes.](https://github.com/SAP/spartacus/pull/12398/files#diff-1db586698a503ea500917fe4d734f84d0729f585aa7c4b56705d9171a38e7f55L64-L120)
- Added styles for `ul.nav` to keep the same appearance.

### ASM changes

- `AsmModule` was removed from storefrontlib, and renamed AsmComponentsModule. Use @spartacus/asm/components instead.
- `AsmModule` was removed from core, and renamed AsmCoreModule. Use @spartacus/asm/core. instead.
- `AsmConfig` was removed from core. Use @spartacus/asm/core.
- `AsmAdapter` was removed. Use @spartacus/asm/core instead.
- `AsmConnector` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH_PAGE_NORMALIZER` was removed. Use @spartacus/asm/core instead.
- `AsmService` was removed. Use @spartacus/asm/core instead.
- `CsAgentAuthService` was removed. Use @spartacus/asm/root instead.
- `CustomerSearchPage` was removed. Use @spartacus/asm/core instead.
- `CustomerSearchOptions` was removed. Use @spartacus/asm/core instead.
- `AsmUi` was removed. Use @spartacus/asm/core instead.
- `AsmAuthHttpHeaderService` was removed. Use @spartacus/asm/root instead.
- `TOKEN_TARGET` was removed. Use @spartacus/asm/root instead.
- `AsmAuthService` was removed. Use @spartacus/asm/root instead.
- `AsmAuthStorageService` was removed. Use @spartacus/asm/root instead.
- `SYNCED_ASM_STATE` was removed. Use @spartacus/asm/core instead.
- `AsmStatePersistenceService` was removed. Use @spartacus/asm/core instead.
- `ASM_UI_UPDATE` was removed. Use @spartacus/asm/core instead.
- `AsmUiUpdate` was removed. Use @spartacus/asm/core instead.
- `AsmUiAction` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH_FAIL` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH_SUCCESS` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH_RESET` was removed. Use @spartacus/asm/core instead.
- `CustomerSearch` was removed. Use @spartacus/asm/core instead.
- `CustomerSearchFail` was removed. Use @spartacus/asm/core instead.
- `CustomerSearchSuccess` was removed. Use @spartacus/asm/core instead.
- `CustomerSearchReset` was removed. Use @spartacus/asm/core instead.
- `CustomerAction` was removed. Use @spartacus/asm/core instead.
- `LOGOUT_CUSTOMER_SUPPORT_AGENT` was removed. Use @spartacus/asm/core instead.
- `LogoutCustomerSupportAgent` was removed. Use @spartacus/asm/core instead.
- `ASM_FEATURE` was removed. Use @spartacus/asm/core instead.
- `CUSTOMER_SEARCH_DATA` was removed. Use @spartacus/asm/core instead.
- `StateWithAsm` was removed. Use @spartacus/asm/core instead.
- `AsmState` was removed. Use @spartacus/asm/core instead.
- `getAsmUi` was removed. Use @spartacus/asm/core instead.
- `getCustomerSearchResultsLoaderState` was removed. Use @spartacus/asm/core instead.
- `getCustomerSearchResults` was removed. Use @spartacus/asm/core instead.
- `getCustomerSearchResultsLoading` was removed. Use @spartacus/asm/core instead.
- `getAsmState` was removed. Use @spartacus/asm/core instead.

### LaunchDialogService

#### SavedCartFormLaunchDialogService

- Service has been removed. `openDialog` method is part of LaunchDialogService now.

#### AddToSavedCartComponent

- Removed `SavedCartFormLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### SavedCartDetailsActionComponent

- Removed `SavedCartFormLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### SavedCartDetailsOverviewComponent

- Removed `SavedCartFormLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### AnonymousConsentLaunchDialogService

- Service has been removed. `openDialog` method is part of LaunchDialogService now.

#### AnonymousConsentManagementBannerComponent

- Removed `AnonymousConsentLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### AnonymousConsentOpenDialogComponent

- Removed `AnonymousConsentLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### ReplenishmentOrderCancellationLaunchDialogService

- Service has been removed. `openDialog` method is part of LaunchDialogService now.

#### ReplenishmentOrderCancellationComponent

- Removed `ReplenishmentOrderCancellationLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

#### ReplenishmentOrderHistoryComponent

- Removed `ReplenishmentOrderCancellationLaunchDialogService` from constructor.
- Added `LaunchDialogService` to constructor.

### SmartEdit

- `SmartEditModule` was removed. Use `@spartacus/smartedit` instead.
- `SmartEditService` was moved to `@spartacus/smartedit/core`.

### Personalization

- `PersonalizationModule` was removed. Use `@spartacus/tracking/personalization` instead.
- `PersonalizationConfig` was moved to `@spartacus/tracking/personalization/root`.
- `PersonalizationContextService` was moved to `@spartacus/tracking/personalization/core`.
- `PersonalizationAction` was moved to `@spartacus/tracking/personalization/core`.
- `PersonalizationContext` was moved to `@spartacus/tracking/personalization/core`.

### WindowRef

- `platformId` is now required constructor dependency.

### Product configurator

`ConfiguratorCartEntryInfoComponent` now also requires `CommonConfiguratorUtilsService`.
`ConfiguratorAttributeCheckboxListComponent` now also requires `ConfiguratorAttributeQuantityService`.
`ConfiguratorAttributeDropDownComponent` now also requires `ConfiguratorAttributeQuantityService`.
`ConfiguratorAttributeRadiButtonComponent` now also requires `ConfiguratorAttributeQuantityService`.
`ConfiguratorStorefrontUtilsService` now also requires `KeyboardFocusService`.

### Product variants changes

#### Automated Migrations for Version 4.0

- `ProductVariantsModule` was removed from @spartacus/storefront. Use `@spartacus/product/variants` feature-library instead.
- `ProductVariantsComponent` was removed from @spartacus/storefront. Use `ProductVariantsContainerComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantColorSelectorComponent` was removed from @spartacus/storefront. Use `ProductVariantColorSelectorComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantColorSelectorModule` was removed from @spartacus/storefront. Use `ProductVariantColorSelectorModule` from `@spartacus/product/variants/components` as a replacement.
- `VariantSizeSelectorComponent` was removed from @spartacus/storefront. Use `ProductVariantSizeSelectorComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantSizeSelectorModule` was removed from @spartacus/storefront. Use `ProductVariantSizeSelectorModule` from `@spartacus/product/variants/components` as a replacement.
- `VariantStyleSelectorComponent` was removed from @spartacus/storefront. Use `ProductVariantStyleSelectorComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantStyleSelectorModule` was removed from @spartacus/storefront. Use `ProductVariantStyleSelectorModule` from `@spartacus/product/variants/components` as a replacement.
- `VariantStyleIconsComponent` was removed from @spartacus/storefront. Use `ProductVariantStyleIconsComponent` from `@spartacus/product/variants/root` as a replacement.
- `ProductVariantStyleIconsComponent` was moved from `@spartacus/product/variants/components`to `@spartacus/product/variants/root` instead.
- `VariantStyleIconsModule` was removed from @spartacus/storefront. Use `ProductVariantStyleIconsModule` from `@spartacus/product/variants/root` as a replacement.
- `ProductVariantStyleIconsModule` was moved from `@spartacus/product/variants/components`to `@spartacus/product/variants/root` instead.
- `ProductVariantGuard` was removed from @spartacus/storefront. Use `ProductVariantsGuard` from `@spartacus/product/variants/components` instead. Additionally method: `findVariant` was renamed to `findPurchasableProductCode`.
- `EventService` no longer uses `FeatureConfigService`.
- `PageEventModule` was removed. Instead, use `NavigationEventModule` from `@spartacus/storefront`
- `PageEventBuilder` was removed. Instead, use `NavigationEventBuilder` from `@spartacus/storefront`
- `CartPageEventBuilder` no longer uses `ActionsSubject` and `FeatureConfigService`
- `HomePageEventBuilder` no longer uses `FeatureConfigService`
- `ProductPageEventBuilder` no longer uses `FeatureConfigService`
- `PageEvent` no longer contains `context`, `semanticRoute`, `url` and `params` properties. These are now contained in the `PageEvent.navigation` object
- `EventsModule` was removed. Use individual imports instead. (e.g. CartPageEventModule, ProductPageEventModule, etc.)

#### Product variants i18n

- translation namespace `variant` was removed from `@spartacus/assets`. Use namespace `variants` that can be imported with `productVariantsTranslations` and `productVariantsTranslationChunksConfig` from `@spartacus/product/variants/assets` instead. Translation keys from this namespace did not changed.

#### Product variants endpoint scope

- scope `variants` was removed from `defaultOccProductConfig`. It's now provided by `ProductVariantsOccModule` under `@spartacus/product/variants/occ` instead. Additionally the endpoint now uses `orgProducts` API instead of `products`.

#### Product variants styles

- styles for `cx-product-variants` were removed from `@spartacus/styles`. Use `@spartacus/product/variants` import instead.

### Feature keys for product configurators

The feature keys that are used to lazily load the product configurator libraries in app.module.ts were available as `rulebased` and `productConfiguratorRulebased` from 3.1 onwards (respective `textfield` and `productConfiguratorTextfield` for the textfield template configurator).

In 4.0, only the longer versions `productConfiguratorRulebased` and `productConfiguratorTextfield` are possible.

Example: A configuration

```
      featureModules: {
        rulebased: {
          module: () => import('@spartacus/product-configurator/rulebased').then(
          (m) => m.RulebasedConfiguratorModule
        ),
        },
      }
```

needs to look like that in 4.0

```
      featureModules: {
        productConfiguratorRulebased: {
          module: () => import('@spartacus/product-configurator/rulebased').then(
          (m) => m.RulebasedConfiguratorModule
        ),
        },
      }
```

### Translations (i18n) changed

- Key `asm.standardSessionInProgress` was removed.

### Storage Sync mechanism

I version 4.0 we removed deprecated in version 3.0 storage sync mechanism. In previous major release we provided more powerful mechanism based on `StatePersistenceService` which can cover all use cases for synchronizing data to and from browser storage (eg. `localStorage`, `sessionStorage`) better than the removed storage sync.

What was removed:

- core of the mechanism (reducer)
- configuration (`storageSync` from `StateConfig`)
- default config and default keys (`defaultStateConfig`, `DEFAULT_LOCAL_STORAGE_KEY` and `DEFAULT_SESSION_STORAGE_KEY`)

### LanguageService

- `LanguageService` no longer uses `WindowRef`. The language initialization from the state was moved to `LanguageInitializer`.
- `LanguageService` now validate the value passed to the method `setActive()` against the iso codes listed in the Spartacus `context` config, before setting the actual value in the ngrx store.
- The initialization of the site context is scheduled a bit earlier than in before (now it's run in an observable stream instead of a Promise's callback). It's a very slight change, but might have side-effects in some custom implementations.
- The active language is now persisted in the Local Storage instead of the Session Storage

### CurrencyService

- `CurrencyService` no longer uses `WindowRef`. The currency initialization from the state was moved to `CurrencyInitializer`.
- `CurrencyService` now validate the value passed to the method `setActive()` against the iso codes listed in the Spartacus `context` config, before setting the actual value in the ngrx store.
- The initialization of the site context is scheduled a bit earlier than in before (now it's run in an observable stream instead of a Promise's callback). It's a very slight change, but might have side-effects in some custom implementations.
- The active currency is now persisted in the LocalStorage instead of the Session Storage.

### Page resolvers

In 3.1 and 3.2 we've introduced a few changes on how the page meta data is collected. The resolvers are now configurable and whether they render on the client or server (SSR) is also configurable. A few resolvers are changed or added, since most data is now configurable in the backend (description, robots). The robot information that was previously hardcoded in some resolvers, are now driven by backend data.

A new feature has landed in the product and category resolvers for the canonical URL.

The `BasePageMetaResolver` is leveraged to compose most of the generic page meta data. Most page resolvers now use the page data to create the description and robot tags. The changes have affected the following resolver classes:

- The `PageMetaService` has a dependency on `UnifiedInjector`, `PageMetaConfig` and the `platformId`.
- The `ContentPageMetaResolver` depends only on the `BasePageMetaResolver`.
- The `BasePageMetaResolver` requires the `Router` and `PageLinkService` to add canonical links to the page meta.
- The `ProductPageMetaResolver` requires the `BasePageMetaResolver` and `PageLinkService`.
- The `CategoryPageMetaResolver` requires the `BasePageMetaResolver`.
- The `SearchPageMetaResolver` requires the `BasePageMetaResolver`.
- The `CheckoutPageMetaResolver` uses the `BasePageMetaResolver`.
- The `OrganizationPageMetaResolver` no longer uses the `BasePageMetaResolver`.
- The `RoutingService` uses the `Router` to resolve the full URL (used to resolve the canonical URL in the page meta resolvers)

The `CmsPageTitleModule` is renamed to `PageMetaModule`.
The `CartPageMetaResolver` is removed since all content is resolved by the generic `ContentPageMetaResolver`.

The following properties where removed in 4.0:

- The `ContentPageMetaResolver` no longer supports the `homeBreadcrumb$`,`breadcrumb$`,`title$` and `cms$` as the content is resolved by the `BasePageMetaResolver`.
- The `resolverMethods` property on the `PageMetaService` has changed to `resolvers$` since the resolvers are read from the configuration stream.

### SelectiveCartService

- The `getLoaded` method was removed. Use `isStable` method instead.

### SearchBoxComponentService

- `SearchBoxComponentService` now also requires `EventService`.

### AddedToCartDialogComponent

- The `increment` property was removed. Use property `numberOfEntriesBeforeAdd` instead.

### CartListItemComponent

- Removed `FeatureConfigService` from constructor and added `UserIdService` and `MultiCartService` to constructor.
- Property `form: FormGroup` is now initialized on component creation instead of in the `createForm()` method.
- `ngOnInit()` method has been modified to fix an issue with rendering items.
- `[class.is-changed]` template attribute on `<div>` tag now depends on method `control.get('quantity').disabled`.

### Models

- The `Item` interface was removed.

### SearchBoxComponent

`RoutingService` is a new, required constructor dependency.

### Organization Administration breaking changes

#### UserGroupUserListComponent

- Removed `MessageService` from constructor.

#### ToggleStatusComponent

- Removed `FeatureConfigService` from constructor.
- Added `DisableInfoService` to constructor.

#### DeleteItemComponent

- Removed `FeatureConfigService` from constructor.

#### UnitChildrenComponent

- `CurrentUnitService` is now required parameter in component constructor.

#### UnitCostCenterListComponent

- `CurrentUnitService` is now required parameter in component constructor.

#### UnitUserListComponent

- `CurrentUnitService` is now required parameter in component constructor.

#### UnitFormComponent

- Renamed property `formGroup` to `form`.
- Removed property `form$`.

#### OrganizationTableType

- Removed unused `UNIT_ASSIGNED_ROLES` property from enum.

#### Translations

- Change contents of:
  `orgBudget.messages.deactivate`,
  `orgCostCenter.messages.deactivate`,
  `orgPurchaseLimit.messages.deactivate`,
  `orgUnit.messages.deactivate`,
  `orgUnitAddress.messages.delete`,
  `orgUserGroup.messages.delete`,
  `orgUser.messages.deactivate`
- Removed unused keys:
  `orgBudget.messages.deactivateBody`,
  `orgCostCenter.messages.deactivateBody`,
  `orgPurchaseLimit.messages.deactivateBody`,
  `orgUnit.messages.deactivateBody`,
  `orgUnitAddress.messages.deleteBody`,
  `orgUserGroup.messages.deleteBody`,
  `orgUser.messages.deactivateBody`

### Dependencies changes

- The peer dependency package `i18next-xhr-backend` was replaced with `i18next-http-backend`.
- The peer dependency package `i18next` was upgraded to the version `20.2.2`

### CmsFeaturesService

- `CmsComponentsService` constructor is now using `CmsFeaturesService` (replacing `FeatureModulesService`) and `ConfigInitializerService`.
- `FeatureModulesService` was removed. Was replaced by `CmsFeaturesService`.

### ItemContext

- `CartItemComponent` now also requires `cartItemContextSource`.
- `ConfiguratorCartEntryInfoComponent` now also requires `commonConfigUtilsService`.
- `ConfiguratorIssuesNotificationComponent` now also requires `CartItemContext`.
- `ProductGridItemComponent` now requires `ProductListItemContextSource`.
- `ProductListItemComponent` now requires `ProductListItemContextSource`.

### User lib changes

#### CMS Components

- Following modules `CloseAccountModule`, `ForgotPasswordModule`, `RegisterComponentModule`, `ResetPasswordModule`, `UpdateEmailModule`, `UpdatePasswordModule`, `UpdateProfileModule` were moved to `@spartacus/user/profile/components`.
- Following modules `LoginModule`, `LoginFormModule`, `LoginRegisterModule` were moved to `@spartacus/user/account/components`.
- Component `ResetPasswordFormComponent` was renamed to `ResetPasswordComponent` and now can be used from `@spartacus/user/profile/components`. Also logic for this component was changed. For details look on sections below.
- Component `UpdateEmailFormComponent` was removed. For replacement `UpdateEmailComponent` from `@spartacus/user/profile/components` can be used.
- Component `UpdatePasswordFormComponent` was removed. For replacement `UpdatePasswordComponent` from `@spartacus/user/profile/components` can be used.
- Component `UpdateProfileFormComponent` was removed. For replacement `UpdateProfileComponent` from `@spartacus/user/profile/components` can be used.
- Components `CloseAccountComponent`, `CloseAccountModalComponent`, `ForgotPasswordComponent`, `RegisterComponent`, `UpdateEmailComponent`, `UpdatePasswordComponent`, `UpdateProfileComponent` were moved to `@spartacus/user/profile/components`. Logic for those components was changed. For details look on sections below.
- Components `LoginComponent`, `LoginFormComponent` were moved to `@spartacus/user/account/components`. Logic for those components was changed. For details look on sections below.
- Component `LoginRegisterComponent` were moved to `@spartacus/user/account/components`.

#### CloseAccountModalComponent

- All services used in constructor have been changed to be `protected`.
- Component is not using `UserService` anymore, `UserProfileFacade` was introduced.
- Component is no longer using `Subscription` property, also `ngOnDestroy` method was removed.

#### ForgotPasswordComponent

- Property `forgotPasswordForm` was renamed to `form`.
- New observable property `isUpdating$` was added.
- Methods `ngOnInit`, `requestForgotPasswordEmail` were removed. New method `onSubmit` was added.
- Services `FormBuilder`, `UserService`, `RoutingService`, `AuthConfigService` are no longer used directly in component file. New service `ForgotPasswordComponentService` was introduced and used in constructor.
- Change detection strategy for this component was set to `OnPush`.
- There were slight changes in component template. Spinner component was added which relys on `isUpdating$` property, also form now is using `onSubmit` method on form submit event.

#### RegisterComponent

- Component is not using `UserService` anymore, `UserRegisterFacade` was introduced.
- Property `loading$` was changed to `isLoading$` and type was change to `BehaviorSubject<boolean>` instead of `Observable<boolean>`.
- Method `registerUserProcessInit` was removed.

#### ResetPasswordComponent (previously ResetPasswordFormComponent)

- Property `subscription` was removed.
- Type of `token` property was changed from `string` to `Observable<string>`.
- Property `resetPasswordForm` was renamed to `form`.
- New observable property `isUpdating$` was added.
- Methods `ngOnInit`, `resetPassword`, `ngOnDestroy` were removed. New method `onSubmit` was added.
- Services `FormBuilder`, `UserService`, `RoutingService`, are no longer used directly in component file. New service `ResetPasswordComponentService` was introduced and used in constructor.
- Change detection strategy for this component was set to `OnPush`.
- Component template was adapted to the new logic.
- Spinner component was added which relys on `isUpdating$` property.

#### LoginComponent

- Component is not using `UserService` anymore, `UserAccountFacade` was introduced.
- Type of `user` property was changed to `Observable<User | undefined>` instead of `Observable<User>`.

#### LoginFormComponent

- Services `AuthService`, `GlobalMessageService`, `FormBuilder`, `WindowRef` are no longer used directly in component file. New service `LoginFormComponentService` was introduced and used in constructor.
- Methods `ngOnInit`, `submitForm`, `loginUser` were removed from component file.
- New properties `form`, `isUpdating$` were added.
- New method `onSubmit` was added.
- Change detection strategy for this component was set to `OnPush`.
- Spinner component was added to the template which relys on `isUpdating$` property.

#### UpdateEmailComponent

- Properties `subscription`, `newUid`, `isLoading$` were removed.
- Methods `ngOnInit`, `onCancel`, `onSuccess`, `ngOnDestroy` were removed from component file.
- Services `GlobalMessageService`, `UserService`, `RoutingService`, `AuthService` are no longer used directly in component file. New service `UpdateEmailComponentService` was introduced and used in constructor.
- Logic for `onSubmit` method was changed. Now this method has no parameters.
- New properties `form`, `isUpdating$` were added.
- There were important change in component template. Since `UpdateEmailFormComponent` was removed `UpdateEmailComponent` contains now the template for update email form itself.
- Change detection strategy for this component was set to `OnPush`.
- Spinner component was added to the template which relys on `isUpdating$` property.

#### UpdatePasswordComponent

- Properties `subscription`, `loading$` were removed.
- Methods `ngOnInit`, `onCancel`, `onSuccess`, `ngOnDestroy` were removed from component file.
- Services `RoutingService`, `UserService`, `GlobalMessageService`, are no longer used directly in component file. New service `UpdatePasswordComponentService` was introduced and used in constructor.
- Logic for `onSubmit` method was changed. Now this method has no parameters.
- New properties `form`, `isUpdating$` were added.
- There were important change in component template. Since `UpdatePasswordFormComponent` was removed `UpdatePasswordComponent` contains now the template for update password form itself.
- Change detection strategy for this component was set to `OnPush`.
- Spinner component was added to the template which relys on `isUpdating$` property.

#### UpdateProfileComponent

- Properties `user$`, `loading$` were removed.
- Methods `ngOnInit`, `onCancel`, `onSuccess`, `ngOnDestroy` were removed from component file.
- Services `RoutingService`, `UserService`, `GlobalMessageService`, are no longer used directly in component file. New service `UpdateProfileComponentService` was introduced and used in constructor.
- Logic for `onSubmit` method was changed. Now this method has no parameters.
- New properties `form`, `isUpdating$` were added.
- There were important change in component template. Since `UpdateProfileFormComponent` was removed `UpdateProfileComponent` contains now the template for update profile form itself.
- Change detection strategy for this component was set to `OnPush`.
- Spinner component was added to the template which relys on `isUpdating$` property.

#### Translations (i18n) changes

- Key `miniLogin.userGreeting` was moved to separated lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `miniLogin.signInRegister` was moved to separated `@spartacus/user` lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `loginForm.signIn` was moved to separated lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `loginForm.register` was moved to separated lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `loginForm.dontHaveAccount` was moved to separated lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `loginForm.guestCheckout` was moved to separated lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `loginForm.emailAddress.label` was moved to separated lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `loginForm.emailAddress.placeholder` was moved to separated lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `loginForm.password.label` was moved to separated lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `loginForm.password.placeholder` was moved to separated lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `loginForm.wrongEmailFormat` was moved to separated lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `loginForm.forgotPassword` was moved to separated lib. Now is a part of `userAccountTranslations`, `userAccountTranslationChunksConfig` from `@spartacus/user/account/assets`.
- Key `updateEmailForm.newEmailAddress.label` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `updateEmailForm.newEmailAddress.placeholder` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `updateEmailForm.confirmNewEmailAddress.label` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `updateEmailForm.confirmNewEmailAddress.placeholder` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `updateEmailForm.enterValidEmail` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `updateEmailForm.bothEmailMustMatch` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `updateEmailForm.password.label` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `updateEmailForm.password.placeholder` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `updateEmailForm.pleaseInputPassword` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `updateEmailForm.emailUpdateSuccess` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `forgottenPassword.resetPassword` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `forgottenPassword.enterEmailAddressAssociatedWithYourAccount` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `forgottenPassword.emailAddress.label` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `forgottenPassword.emailAddress.placeholder` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `forgottenPassword.enterValidEmail` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `forgottenPassword.passwordResetEmailSent` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `forgottenPassword.passwordResetSuccess` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.confirmPassword.action` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.confirmPassword.label` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.confirmPassword.placeholder` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.managementInMyAccount` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.termsAndConditions` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.signIn` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.register` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.confirmNewPassword` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.resetPassword` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.createAccount` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.title` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.firstName.label` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.firstName.placeholder` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.lastName.label` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.lastName.placeholder` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.emailAddress.label` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.emailAddress.placeholder` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.password.label` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.password.placeholder` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.newPassword` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.emailMarketing` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.confirmThatRead` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.selectTitle` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.passwordMinRequirements` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.bothPasswordMustMatch` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.titleRequired` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.
- Key `register.postRegisterMessage` was moved to separated lib. Now is a part of `userProfileTranslations`, `userProfileTranslationChunksConfig` from `@spartacus/user/profile/assets`.

#### Changes in styles

- Styles for following selectors `cx-close-account-modal`, `cx-close-account`, `cx-forgot-password`, `cx-register`, `cx-update-password-form`, `cx-user-form` were moved from `@spartacus/styles` to `@spartacus/user/profile/styles`.
- Styles for following selectors `cx-login`, `cx-login-form` were moved from `@spartacus/styles` to `@spartacus/user/account/styles`.

### LogoutGuard

`AuthRedirectService` is a new, required constructor dependency.
