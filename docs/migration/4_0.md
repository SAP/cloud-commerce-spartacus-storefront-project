# Technical Changes in Spartacus 4.0

## Breaking Changes Introduced in 4.0

## ConfiguratorCartService
Lib: @spartacus/product-configurator
Class: ConfiguratorCartService
Change: The type of constructor parameter `checkoutService: CheckoutService` is changed to `checkoutFacade: CheckoutFacade` to adapt to the new checkout lib. 
### AddressBookComponentService
Lib: @spartacus/core
Class: AddressBookComponentService
Change: constructor parameter `checkoutDeliveryService: CheckoutDeliveryService` is removed.
It is replaced with new constructor parameter `eventService: EventService`.

Since the reference to `CheckoutDeliveryService` is removed, the `AddressBookComponentService` fires events when an address is changed.

Address data update fires event: `UserAddressUpdateEvent`.
Setting an address as default fires: `UserAddressSetToDefaultEvent`.
Deleting an address fires event: `UserAddressDeleteEvent`.

All these events have the same parent class `UserAddressChangeEvent`.

### AddressBookComponent
Lib: @spartacus/core
Class: AddressBookComponent
Change: Two constructor parameters are removed.  First the constructor parameter `checkoutDeliveryService: CheckoutDeliveryService` is removed.
AddressBookComponent does not call `CheckoutDeliveryService.clearCheckoutDeliveryDetails()` anymore when an address is changed.  Instead, `AddressBookComponentService` fires events.  See `AddressBookComponentService` migration doc.

The second constructor parameters removed is `userAddressService: UserAddressService`. `UserAddressService` interactions are now encapsulated in `AddressBookComponentService`.


### AddressFormComponent
Lib: @spartacus/core
Class: AddressFormComponent
Change: constructor parameter `checkoutDeliveryService: CheckoutDeliveryService` is removed.
AddressFormComponent now uses the new address verification function from  `UserAddressService` called `verifyAddress` instead of the `verifyAddress` function from `CheckoutDeliveryService`.  `UserAddressService.verifyAddress` does not use the ngrx store under the hood.


### UserAddressService
Lib: @spartacus/core
Class: UserAddressService
Change: Two new required constructor parameters `userAddressConnector: UserAddressConnector` and `command: CommandService`

## CheckoutEventModule
Lib: @spartacus/core and  @spartacus/checkout
Class: CheckoutEventModule
Change: One new required constructor parameters `_checkoutEventListener: CheckoutEventListener`

## PaymentFormComponent
Lib: @spartacus/checkout
Class: PaymentFormComponent
Changes: 
- PaymentFormComponent does not implement `OnDestroy` anymore
- method `ngOnDestroy()` removed.
- Address verification uses new `UserAddressService.verifyAddress` function instead of `CheckoutDeliveryService.verifyAddress`. 


## Changes in the classes carried over to checkout lib

To split out the checkout code in the checkout lib, the address verification functionality
was moved in `UserAddressService` in @spartacus/core.  The address verification related functions in `CheckoutDeliveryService` and ngrx supporting classes are not present in the checkout lib.

These functions are not present in the checkout lib:
### CheckoutDeliveryService functions:
- `getAddressVerificationResults(): Observable<AddressValidation | string>`
- `verifyAddress(address: Address): void`
- `clearAddressVerificationResults(): void`

These functions are also not present in the corresponding facade `CheckoutDeliveryFacade`

### CheckoutState
Property `addressVerification: AddressVerificationState` is removed froom the `CheckoutState` class in the checkout lib.

### AddressVerificationState
The `AddressVerificationState` class is not carried over to the checkout lib.



