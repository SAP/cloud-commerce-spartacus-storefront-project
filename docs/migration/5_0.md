# Technical Changes in Spartacus 5.0

## CMS related changes in product-configurator library

### Reduced number of page header slots and introduction of exit button

In case the rulebased product configurator is launched from product details, product catalog, or cart, the number of slots displayed in
the page header has been reduced compared to 4.0. We only show slots `SiteLogo`,`VariantConfigOverviewExitButton` and `MiniCart`.
For details see `CpqConfiguratorLayoutModule`, `VariantConfiguratorInteractiveLayoutModule` and `VariantConfiguratorOverviewLayoutModule`.
These modules are new in 5.0. The layout configuration was removed from `CpqConfiguratorInteractiveModule`, `VariantConfiguratorInteractiveModule`
and `VariantConfiguratorOverviewModule`.

Note that `VariantConfigOverviewExitButton` is new, and allows to leave the configuration. Clicking it directs the user to the product detail
page, configuration changes are not taken over to the cart.

### Specific page header slots in case configurator is launched in displayOnly mode

In case the rulebased product configurator is launched from the checkout review order page, from the order confirmation page or from the order
history page, the page header shows the standard Spartacus header slots (not the reduced set of header slots listed in the previous section).
Specifically, `VariantConfigOverviewExitButton` is not offered then.
For details, see `CpqConfiguratorPageLayoutHandler` and `VariantConfiguratorPageLayoutHandler`.
The page header slots used in case of the displayOnly mode can be configured in `CpqConfiguratorLayoutModule` and `VariantConfiguratorOverviewLayoutModule`,
under the section `headerDisplayOnly`.

## Breaking Changes Introduced in 5.0

### Translation (i18n) changes

- `configurator.addToCart.buttonDisplayOnly` was added to `configurator-common.ts`
- `quickOrder.entriesWasAdded` changed to `quickOrder.entriesWereAdded`
- `payment.paymentForm.setAsDefault` changed from `Set as default` to `Set as default payment method` for screen reader improvements
- Translation for key `address.addressForm.setAsDefault` changed from `Set as default` to `Set as default shipping address`

### ConfiguratorAddToCartButtonComponent

- `#displayOnly` template was added
- `<button class="cx-btn btn btn-block btn-primary cx-display-only-btn"></button>` was added to the `#displayOnly` template
- Now also uses `configurator.addToCart.buttonDisplayOnly` translation label key
- Added `OrderFacade` to constructor.
- Added `CommonConfiguratorUtilsService` to constructor.

### ShippingAddressComponent

- Added `GlobalMessageService` to constructor.

### OrderConfirmationThankYouMessageComponent

- Component template was modified to display `span` instead of `h1` for page title.

### PromotionsComponent

- Component template was modified to display single promotions using the `p` tag and multiple promotions using `ul` list elements

### ConfiguratorCartEntryBundleInfoComponent

- `TranslationService` was added to constructor

### CartDetailsComponent

- Component template was modified to display `h2` instead of `h4` for cart name.

### CartItemComponent

- Component template was modified to display `h3` instead of `h2` for product name.

### OrderSummaryComponent

- Component template was modified to display `h2` instead of `h3` for order summary.

### ProductAttributesComponent

- Component template was modified to display `h2` instead of `h3` for classification name.

### CartCouponComponent

- Component template was modified to display coupon as a `label` inside a form. Previously it was in a `div` before `form` tag.

### CardComponent

- Component template was modified to display `span` instead of `h3` for card title.

### AuthHttpHeaderService

- The `refreshInProgress` property was removed. Use `refreshInProgress$` Observable instead.
- The `handleExpiredToken` method was removed. Use `getValidToken` instead.
- In `handleExpiredAccessToken` method third parameter `initialToken` is now required.

### QuickOrderService

- Removed `ProductAdapter` from constructor.
- Added `ProductSearchConnector` to constructor.
- The `search` method was removed. Use `searchProducts` instead.
- The `removeEntry` method was removed. Use `softDeleteEntry` instead.

### QuickOrderFormComponent

- Removed `GlobalMessageService` from constructor.
- Added `Config` to constructor.
- Added `ChangeDetectorRef` to constructor.
- Added `WindowRef` to constructor.

### BreadcrumbComponent
#### Template changes 

- `breadcrumb.component.html` markup structure change from `nav > span > a` to `nav > ol > li > a` for Screen reader improvements and corresponding styles has also been updated.

#### Translation (i18n) changes
- `common.breadcrumbs` was added to `common.ts`

### ConfiguratorAttributeProductCardComponent
- `span` added (visually hidden) for screen-reader to read explanation for hidden button (in case option .hideRemoveButton is true

### ConfiguratorAttributeDropDownComponent
- `label` added (visually hidden) for screen-reader to read explanation of drop-down listbox (number of entries)

### ConfiguratorAttributeReadOnlyComponent
#### for staticDomain part:
- `span` added (visually hidden) for screen-reader to read  `value x of attribute y` (in order to better distinguish between text of a value and text of an attribute for screen-reader users)
- `span` added with `aria-hidden=true` around visible read-only value to avoid double reading by screen-reader
#### for #noStaticDomain template:
- `span` added (visually hidden) for screen-reader to read  `value x of attribute y` (in order to better distinguish between text of a value and text of an attribute for screen-reader users)
- `span` added with `aria-hidden=true` around visible read-only value to avoid double reading by screen-reader
#### for userInput part:
- `span` added (visually hidden) for screen-reader to read  `value x of attribute y` (in order to better distinguish between text of a value and text of an attribute for screen-reader users)
- `span` added with `aria-hidden=true` around visible read-only value to avoid double reading by screen-reader

### ConfiguratorAttributeSingleSelectionBundleDropdownComponent
- `label` added (visually hidden) for screen-reader to read explanation of drop-down listbox (number of entries)

### ConfiguratorAttributeSingleSelectionImageComponent
- enclosing `div` added with attribute `role=listbox` to make clear for screen-reader that the enclosed divs belong to a list selection

### ConfiguratorConflictSuggestionComponent
- `span`-tags added around suggestion title and texts with attribute `aria-hidden=true` as the text for screen-reader is taken over by new attribute aria-label at `div`-tag to provide consistent screen-reader text for different browsers

### ConfiguratorAttributeSingleSelectionImageComponent
- `span`-tags added (visually hidden) to provide extra information for screen-reader users

### ConfiguratorOverviewAttributeComponent
- `span` added (visually hidden) for screen-reader to read `value x of attribute y` or `value x of attribute y surcharge z` if a price is present (in order to better distinguish between text of a value and text of an attribute for screen-reader users)

### ConfiguratorOverviewBundleAttributeComponent
 - `span` added (visually hidden) for screen-reader to read `item x of attribute y`, `item x of attribute y, surcharge z`, `item x of attribute y, quantity 123` or `item x of attribute y, quantity 123, surcharge z` depending on availability of price and quantity

### ConfiguratorOverviewFormComponent
- `span`-tags added (visually hidden) to provide extra information for screen-reader users

### ConfiguratorProductTitleComponent
- `span` with attribute `aria-hidden=true` around visible link text to avoid double reading by screen-reader (text is covered by new `aria-label` attribute of surrounding `div`)

### Translation (i18n) changes related to accessibility in variant configuration
The following keys have been added to `configurator-common.ts`:
- `configurator.a11y.xx`
- `configurator.a11y.configureProduct`
- `configurator.a11y.cartEntryBundleInfo`
- `configurator.a11y.cartEntryBundleInfo_plural`
- `configurator.a11y.cartEntryBundleName`
- `configurator.a11y.cartEntryBundleNameWithQuantity`
- `configurator.a11y.cartEntryBundleNameWithPrice`
- `configurator.a11y.cartEntryBundle`
- `configurator.a11y.cartEntryInfoIntro`
- `configurator.a11y.cartEntryInfo`
- `configurator.a11y.nameOfAttribute`
- `configurator.a11y.valueOfAttribute`
- `configurator.a11y.forAttribute`
- `configurator.a11y.valueOfAttributeFull`
- `configurator.a11y.valueOfAttributeFullWithPrice`
- `configurator.a11y.selectedValueOfAttributeFull`
- `configurator.a11y.selectedValueOfAttributeFullWithPrice`
- `configurator.a11y.readOnlyValueOfAttributeFull`
- `configurator.a11y.valueOfAttributeBlank`
- `configurator.a11y.value`
- `configurator.a11y.attribute`
- `configurator.a11y.requiredAttribute`
- `configurator.a11y.listOfAttributesAndValues`
- `configurator.a11y.editAttributesAndValues`
- `configurator.a11y.group`
- `configurator.a11y.itemOfAttributeSelected`
- `configurator.a11y.itemOfAttributeSelectedWithPrice`
- `configurator.a11y.itemOfAttributeSelectedPressToUnselect`
- `configurator.a11y.itemOfAttributeSelectedPressToUnselectWithPrice`
- `configurator.a11y.itemOfAttributeUnselected`
- `configurator.a11y.itemOfAttributeUnselectedWithPrice`
- `configurator.a11y.selectNoItemOfAttribute`
- `configurator.a11y.itemOfAttribute`
- `configurator.a11y.itemOfAttributeFull`
- `configurator.a11y.itemOfAttributeFullWithPrice`
- `configurator.a11y.itemOfAttributeFullWithQuantity`
- `configurator.a11y.itemOfAttributeFullWithPriceAndQuantity`
- `configurator.a11y.itemDescription`
- `configurator.a11y.listbox`
- `configurator.a11y.valueSurcharge`
- `configurator.a11y.conflictDetected`
- `configurator.a11y.conflictsInConfiguration`
- `configurator.a11y.listOfGroups`
- `configurator.a11y.inListOfGroups`
- `configurator.a11y.groupName`
- `configurator.a11y.groupBack`
- `configurator.a11y.conflictBack`
- `configurator.a11y.iconConflict`
- `configurator.a11y.iconIncomplete`
- `configurator.a11y.iconComplete`
- `configurator.a11y.iconSubGroup`
- `configurator.a11y.next`
- `configurator.a11y.previous`
- `configurator.a11y.showMoreProductInfo`
- `configurator.a11y.showLessProductInfo`
- `configurator.a11y.productName`
- `configurator.a11y.productCode`
- `configurator.a11y.productDescription`
- `configurator.a11y.configurationPage`
- `configurator.a11y.configurationPageLink`
- `configurator.a11y.overviewPage`
- `configurator.a11y.overviewPageLink`
