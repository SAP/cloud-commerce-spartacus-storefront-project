#!/bin/bash

#################################################################################################################################
# Variables
#################################################################################################################################

RED='\033[0;31m'
NC='\033[0m'

#################################################################################################################################


echo
test -f log.txt && rm log.txt


#################################################################################################################################
# Unit tests
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running unit tests
=================================================================================================================================
EOF

ng test --watch=false 2>&1 | tee log.txt

if grep -q 'FAILED' "log.txt";
then
        rm log.txt
        echo -e "${RED}Error: One or more unit tests failed.${NC}"
        exit 1;
else
        echo 'All unit tests passed'
fi

#################################################################################################################################


echo


#################################################################################################################################
# Unit test coverage
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running ng test --code-coverage
=================================================================================================================================
EOF

ng test --code-coverage --watch=false 2>&1 | tee log.txt

##################################################################################################################################


rm log.txt
echo


#################################################################################################################################
# yarn in spaccelerator
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running yarn in spaccelerator
=================================================================================================================================
EOF

yarn || {
	rm log.txt
	echo -e "${RED}Error: Failed to install dependencies in spaccelerator.${NC}"
	exit 1
}

#################################################################################################################################


echo


#################################################################################################################################
# yarn build-lib in spaccelerator
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running yarn build-lib in spaccelerator
=================================================================================================================================
EOF

yarn build-lib || {
	echo -e "${RED}Error: Failed to build lib in spaccelerator.${NC}"
	exit 1
}

#################################################################################################################################


cd ../spaccwrapper
echo


#################################################################################################################################
# yarn in spaccwrapper
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running yarn in spaccwrapper
=================================================================================================================================
EOF

yarn || {
	echo -e "${RED}Error: Failed to install dependencies in spaccwrapper.${NC}"
	exit 1
}

#################################################################################################################################


echo


#################################################################################################################################
# yarn install-lib in spaccwrapper
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running yarn install-lib in spaccwrapper
=================================================================================================================================
EOF

yarn install-lib || {
	echo -e "${RED}Error: Failed to install lib in spaccwrapper.${NC}"
	exit 1
}

#################################################################################################################################


cd ../spaccelerator
echo


#################################################################################################################################
# ng build --aot in spaccelerator
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running ng build --aot in spaccelerator
=================================================================================================================================
EOF

ng build --aot || {
	echo -e "${RED}Error: Failed to build aot in spaccelerator.${NC}"
	exit 1
}

#################################################################################################################################


echo


#################################################################################################################################
# ng build --prod in spaccelerator
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running ng build --prod in spaccelerator
=================================================================================================================================
EOF

ng build --prod || {
	echo -e "${RED}Error: Failed to build prod in spaccelerator.${NC}"
	exit 1
}

#################################################################################################################################


echo
echo "Please enter the path to your commercewebservices-module/ycommercewebservices/web/webroot directory or press 'c' to continue without providing a path: " 
read WEBROOT_DIR

while [[ ! -d "$WEBROOT_DIR" && "$WEBROOT_DIR" != "c" ]];
do
  	echo "The path you entered was incorrect, please either enter the correct path to your commercewebservices-module/ycommercewebservices/web/webroot directory or enter 'c' to continue without providing a path: "
	read WEBROOT_DIR
done

SPA_DIR="$WEBROOT_DIR/spa"


#################################################################################################################################
# Copying spaccelerator/dist/* to commercewebservices-module/ycommercewebservices/web/webroot/spa
#################################################################################################################################

if [ "$WEBROOT_DIR" != "c" ]; 
then
cat << EOF

=================================================================================================================================
Running ng build --prod --base-href=/rest/spa/ in spaccelerator
=================================================================================================================================
EOF

	ng build --prod --base-href=/rest/spa/

cat << EOF
=================================================================================================================================
Copying spaccelerator/dist/* to commercewebservices-module/ycommercewebservices/web/webroot/spa
=================================================================================================================================
EOF

  	test -d "$SPA_DIR" || mkdir "$SPA_DIR"
	cp -R dist/. "$SPA_DIR" && {
		echo "Files copied successfully."
	}
fi

#################################################################################################################################


echo


#################################################################################################################################
# ng lint in spaccelerator
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running ng lint in spaccelerator
=================================================================================================================================
EOF

ng lint || {
	exit 1
}

#################################################################################################################################


cd ../spaccwrapper
echo


#################################################################################################################################
# ng lint in spaccwrapper
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running ng lint in spaccwrapper
=================================================================================================================================
EOF

ng lint || {
	exit 1
}

#################################################################################################################################


cd ../spaccelerator
echo


cat << EOF
=================================================================================================================================
                          ADDITIONAL THINGS TO MANUALLY CHECK BEFORE MERGING OR PUSHING CHAGES
=================================================================================================================================
1) Open the index.html file located inside your spaccelerator/coverage folder and make sure that the unit test coverage for the 
   modules or components you've worked on is at least 80%.

2) If you have provided the correct path to your ycommercewebservices/web/webroot/ directory then open your web browser and make 
   sure that SPA is running on https://localhost:9002/rest/spa/.

3) Make sure that the spaccwrapper app runs without any errors.

4) If you have made any of the following changes in spaccelerator, please also update the spawrapper app accordingly:
    - Added or changed a route.
    - Changed the path or name of a module.
    - Added a component or module.
=================================================================================================================================
EOF


echo