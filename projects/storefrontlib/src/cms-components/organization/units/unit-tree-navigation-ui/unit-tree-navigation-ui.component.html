<ng-container>
  <div class="cx-unit-tree-actions">
    <button class="btn btn-link" (click)="setTreeBranchesState(true)">
      Expand all
    </button>
    <button class="btn btn-link" (click)="setTreeBranchesState(false)">
      Collapse all
    </button>
  </div>

  <a *ngIf="selectedNode" (click)="back()" tabindex="0">
    < Up one level
  </a>

  <ng-container
    *ngTemplateOutlet="
      tree;
      context: {
        node: selectedNode
          ? selectedNode
          : {
              title: '',
              children: [node]
            },
        code: 'unit_tree',
        depth: 0
      }
    "
  >
  </ng-container>

  <ng-template #tree let-node="node" let-code="code" let-depth="depth">
    <ul [attr.data-code]="code" [attr.data-depth]="depth">
      <li
        *ngFor="let child of node.children; let i = index"
        [attr.aria-expanded]="isExpandedNodeMap[code + '_' + i]"
      >
        <div class="tree-desktop-branch">
          <cx-icon
            *ngIf="child.children?.length > 0"
            [type]="
              isExpandedNodeMap[code + '_' + i]
                ? iconType.CARET_DOWN
                : iconType.CARET_RIGHT
            "
            (click)="toggleAriaExpandedForNode(code + '_' + i)"
            (keydown.enter)="toggleAriaExpandedForNode(code + '_' + i)"
            (keydown.space)="toggleAriaExpandedForNode(code + '_' + i)"
            tabindex="0"
          ></cx-icon>
          <cx-generic-link
            [url]="child.url"
            [title]="child.title"
            [class.margin-left]="!child.children?.length"
          >
            {{ child.title }}
            <span *ngIf="child.children?.length > 0"
              >({{ child.children?.length }})</span
            >
          </cx-generic-link>
        </div>

        <div class="tree-mobile-branch">
          <cx-generic-link
            [url]="child.url"
            [title]="child.title"
            [class.margin-left]="!child.children?.length"
          >
            {{ child.title }}
            <span *ngIf="child.children?.length > 0">
              ({{ child.children?.length }})
            </span>
          </cx-generic-link>
          <cx-icon
            *ngIf="child.children?.length > 0"
            [type]="iconType.CARET_RIGHT"
            (click)="selectUnitNode(child, code + '_' + i)"
            (keydown.enter)="selectUnitNode(child, code + '_' + i)"
            (keydown.space)="selectUnitNode(child, code + '_' + i)"
            tabindex="0"
          ></cx-icon>
        </div>

        <ng-container
          *ngTemplateOutlet="
            tree;
            context: {
              node: child,
              code: code + '_' + i,
              depth: depth + 1
            }
          "
        >
        </ng-container>
      </li>
    </ul>
  </ng-template>
</ng-container>
